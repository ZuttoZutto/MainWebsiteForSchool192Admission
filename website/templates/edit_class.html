{% extends "base.html" %}

{% block content %}
<h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞—Å—Å–µ</h1>

<div id="edit-container">
    <form id="edit-form" method="POST">
        <label for="number">–¶–∏—Ñ—Ä–∞:</label>
        <input type="number" id="number" name="number" required min="1"><br>

        <label for="letter">–ë—É–∫–≤–∞:</label>
        <input type="text" id="letter" name="letter" pattern="^[–ê-–Ø]$" title="–¢–æ–ª—å–∫–æ –∑–∞–≥–ª–∞–≤–Ω—ã–µ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã" maxlength="1" required><br>

        <label for="profile">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è:</label>
        <select id="profile-select" name="profile" required>
            <option disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</option>
        </select>
        <input type="hidden" id="profile-id" name="profile-id">

        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    </form>
</div>

<h2>–≠–∫–∑–∞–º–µ–Ω—ã –∫–ª–∞—Å—Å–∞</h2>

<table id="exams-table" class="display">
    <thead>
        <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–î–∞—Ç–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ -->
<button id="choose-exam-button">–í—ã–±—Ä–∞—Ç—å —ç–∫–∑–∞–º–µ–Ω—ã</button>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GET-–∑–∞–ø—Ä–æ—Å—ã
    Promise.all([
        fetch(`/admission192/api/classes/${window.location.pathname.split('/')[2]}`),
        fetch('/api/profiles')
    ])
    .then((responses) => Promise.all(responses.map(res => res.json())))
    .then(([classData, profilesData]) => {
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
        document.getElementById('number').value = classData.Class.number;
        document.getElementById('letter').value = classData.Class.letter;

        // –ù–∞—Ö–æ–¥–∏–º select-—ç–ª–µ–º–µ–Ω—Ç –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è–º–∏
        const selectElement = document.getElementById('profile-select');
        profilesData.forEach(profile => {
            const option = document.createElement('option');
            option.value = profile.id;
            option.textContent = profile.Name;
            selectElement.appendChild(option);
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —Å —Ç–∞–∫–∏–º ID
        const foundProfile = Array.from(selectElement.options).find(opt => opt.value === String(classData.Class.profile_id));

        if (foundProfile) {
            selectElement.value = classData.Class.profile_id;
            document.getElementById('profile-id').value = classData.Class.profile_id;
        } else {
            console.error('–ü—Ä–æ—Ñ–∏–ª—è —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.', classData.Class.profile_id);
        }

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã
        const tbody = document.querySelector('#exams-table tbody');

        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–º—É —ç–∫–∑–∞–º–µ–Ω—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É
        for (let examId in classData.Exams) {
            const exam = classData.Exams[examId];
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><a href="/from_classes_exams/${window.location.pathname.split('/')[2]}/${examId}">${exam.name}</a></td>
                <td>${exam.date}</td>
                <td>
                    <button class="delete-btn" data-exam-id="${examId}" title="–£–¥–∞–ª–∏—Ç—å —ç–∫–∑–∞–º–µ–Ω">
                        üóëÔ∏è
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º DataTables
        $('#exams-table').DataTable();

        // *** –î–æ–±–∞–≤–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã ***
        document.getElementById('edit-form').addEventListener('submit', async event => {
            event.preventDefault(); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
            const classNumber = document.getElementById('number').value;
            const classLetter = document.getElementById('letter').value;
            const profileSelect = document.getElementById('profile-select');
            const profileId = profileSelect.options[profileSelect.selectedIndex].value;

            // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∞—Å—Å–∞ –ø–æ–ª—É—á–∞–µ–º –∏–∑ URL
            const classId = window.location.pathname.split('/')[2];

            // –°–ø–∏—Å–æ–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —ç–∫–∑–∞–º–µ–Ω–æ–≤
            const examsIds = Object.keys(classData.Exams).map(id => Number(id)); // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π –≤ —á–∏—Å–ª–æ–≤–æ–π –≤–∏–¥

            // –ì–æ—Ç–æ–≤–∏–º JSON –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const requestPayload = {
                Class: {
                    id: Number(classId),
                    number: Number(classNumber),
                    letter: classLetter,
                    profile_id: Number(profileId)
                },
                Exams: examsIds
            };

            try {
                const response = await fetch('/api/classes/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestPayload)
                });

                if (response.ok) {
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É "/classes"
                    window.location.href = '/classes';
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö:', response.statusText);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö:', err.message);
            }
        });

        // *** –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É ***
        document.getElementById('choose-exam-button').addEventListener('click', async event => {
            event.preventDefault(); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π
            const classNumberInput = document.getElementById('number');
            const classLetterInput = document.getElementById('letter');

            if (!classNumberInput.checkValidity() || !classLetterInput.checkValidity()) {
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
            const classNumber = classNumberInput.value;
            const classLetter = classLetterInput.value;
            const profileSelect = document.getElementById('profile-select');
            const profileId = profileSelect.options[profileSelect.selectedIndex].value;

            // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∞—Å—Å–∞ –ø–æ–ª—É—á–∞–µ–º –∏–∑ URL
            const classId = window.location.pathname.split('/')[2];

            // –°–ø–∏—Å–æ–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —ç–∫–∑–∞–º–µ–Ω–æ–≤
            const examsIds = Object.keys(classData.Exams).map(id => Number(id)); // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π –≤ —á–∏—Å–ª–æ–≤–æ–π –≤–∏–¥

            // –ì–æ—Ç–æ–≤–∏–º JSON –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const requestPayload = {
                Class: {
                    id: Number(classId),
                    number: Number(classNumber),
                    letter: classLetter,
                    profile_id: Number(profileId)
                },
                Exams: examsIds
            };

            try {
                const response = await fetch('/api/classes/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestPayload)
                });

                if (response.ok) {
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É "/choose_exam_for_class/:class_id"
                    window.location.href = `/choose_exam_for_class/${classId}`;
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö:', response.statusText);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö:', err.message);
            }
        });

        // *** –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è ***
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async event => {
                event.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
                event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏

                // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∞—Å—Å–∞ –ø–æ–ª—É—á–∞–µ–º –∏–∑ URL
                const classId = window.location.pathname.split('/')[2];

                // –ü–æ–ª—É—á–∞–µ–º ID —ç–∫–∑–∞–º–µ–Ω–∞ –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–∞ data-exam-id
                const examId = button.getAttribute('data-exam-id');

                // –§–æ—Ä–º–∏—Ä—É–µ–º JSON –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const deletePayload = {
                    ExamId: Number(examId)
                };

                try {
                    const response = await fetch(`/admission192/api/examslist/${classId}/`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(deletePayload)
                    });

                    if (response.ok) {
                        // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                        button.closest('tr').remove();
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç–∫–∑–∞–º–µ–Ω–∞:', response.statusText);
                    }
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç–∫–∑–∞–º–µ–Ω–∞:', err.message);
                }
            });
        });
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    });
});
</script>
{% endblock %}